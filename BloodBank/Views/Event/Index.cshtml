@using Domain.Model.Posts
@{
    ViewData["Title"] = "Event";
}

<div class="panel-heading">
    <h3 class="panel-title"><a href="javascript:void(0);" class="toggle-sidebar"><span class="fa fa-angle-double-left" data-toggle="offcanvas" title="Maximize Panel"></span></a>@ViewData["Title"]</h3>
</div>
<div class="panel-body">
    <div class="content-row">
            <h2 class="content-row-title">Event Management</h2>
            <div class="page-breadcrumb bg-white">
                <div class="row align-items-center">
                    <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12">
                        <button type="button" class="btn btn-primary" id="add-button">
                            Add
                        </button>
                    </div>
                </div>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Content</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Status</th>
                        <th>Image</th>

                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tableevent">
                </tbody>
            </table>
            <div class="row mt-4 content-center">
                <div class="col-md-6">
                    <ul class="pagination" id="page_container">
                    </ul>
                </div>
            </div>
            <div class="modal" id="myModal">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div class="modal-header">
                            <h4 class="modal-title"> event</h4>
                            <button type="button" class="btn-close" data-dismiss="modal"></button>
                        </div>

                        <!-- Modal body -->
                        <div class="modal-body">
                            <div class="form-group">
                                <form id="post-form" enctype="multipart/form-data">
                                    <input type="hidden" id="event-id" name="event-id">
                                    <div class="form-group">
                                        <label for="name">Name</label>
                                        <input type="text" class="form-control" id="name" name="name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="description">Description</label>
                                        <textarea class="form-control" id="description" name="description" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="content">Content</label>
                                        <textarea class="form-control" id="content" name="content" required></textarea>
                                    </div>
                                    <div class="form-group">
                                       <label for="startdate">Start Date</label>
                                        <input type="date" class="form-control" id="startdate" name="startdate" required>
                                    </div>
                                     <div class="form-group">
                                      <label for="endate">End Date</label>
                                        <input type="date" class="form-control" id="endate" name="endate" required>
                                    </div>
                                    <div class="form-group">
                                      <label for="status">Status</label>
                                        <select name="status" id="status">
                                            <option value="0">None</option>
                                            <option value="1">Upcoming</option>
                                            <option value="2">Ongoing</option>
                                            <option value="3">Finished</option>
                                            <option value="4">Canceled</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="image">Image</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="image" name="image">
                                        </div>
                                        <img id="image-preview" src="" height="100" style="display: none;">
                                    </div>
                                    <button type="submit" id="submit-button" class="btn btn-primary">Save</button>
                                </form>

                            </div>
                        </div>
                    </div>

                </div>


        </div>
    </div>
    <!-- jQuery library -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

    
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script>
        $(document).ready(function () {

            // Function to load data from the API and display it in the table
            function loadData() {
                $('#post-form')[0].reset();
                $.ajax({
                    url: "/api/event",
                    type: "GET",
                    success: function (response) {
                        var data = response.data;
                        var tableBody = $("#tableevent");
                        tableBody.empty();
                        for (var i = 0; i < data.length; i++) {
                            var row = "<tr>" +
                                "<td>" + data[i].id + "</td>" +
                                "<td>" + data[i].eventName + "</td>" +
                                "<td>" + data[i].description + "</td>" +
                                "<td>" + data[i].content + "</td>" +
                                "<td>" + moment(data[i].startTime).format('DD-MM-YYYY') + "</td>" +
                                 "<td>" + moment(data[i].endTime).format('DD-MM-YYYY') + "</td>" +
                                "<td>" + (data[i].status == 0 ? "None" : data[i].status == 1 ? "Upcoming" : data[i].status == 2 ? "Ongoing" :data[i].status == 3?"Finished":"Canceled") + "</td>" +
                                "<td><img src='" + data[i].image.url + "' height='100'></td>" +
                                "<td><button class='edit-button' data-data='" + JSON.stringify(data[i]) + "'>Edit</button></td>" +
                                "<td><button class='delete-button' data-id='" + data[i].id + "' > Delete </button></td>" +
                                "</tr>";
                            tableBody.append(row);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("Error loading data from the API: " + errorThrown);
                    }
                });
            }
            loadData();
            $("#post-form").submit(function (event) {
                event.preventDefault();
                let data = {
                    eventName: $("#name").val(),
                    description: $("#description").val(),
                    content: $("#content").val(),
                    startTime: new Date($("#startdate").val()).toJSON(),
                    endTime: new Date($("#endate").val()).toJSON(),
                    status: new Number($("#status").val()),
                };
                let jsonString = JSON.stringify(data);
                console.log(jsonString);
                var formData = new FormData();
                formData.append("jsonString", jsonString);
                formData.append("file", $("#image")[0].files[0]);
                var id = $("#event-id").val();
                console.log(id);
                if (id == null || id=="") {
                    $.ajax({
                        url: "/api/event",
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            alert("Successfully!");
                            loadData();
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error creating : " + errorThrown);
                        }
                    });
                }
                else {
                    $.ajax({
                        url: "/api/event/" + id,
                        type: "PUT",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            alert("Successfully!");
                            loadData();
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error updating: " + errorThrown);
                        }
                    });
                }
            });

            // Function to handle the edit button click
            $(document).on("click", ".edit-button", function () {
                event.preventDefault();
                jQuery.noConflict();
                var data = $(this).data("data");
                $("#event-id").val(data.id);
                $("#name").val(data.eventName);
                $("#description").val(data.description);
                $("#content").val(data.content);
                $('#startdate').val(moment(data.startTime).format('YYYY-MM-DD'));
                $('#endate').val(moment(data.endTime).format('YYYY-MM-DD'));
                $("#status").val(data.status);
                $('#image-preview').attr('src', data.image.url);
                $('#myModal').modal('show');
            });
            $(document).on("click", "#add-button", function () {
                event.preventDefault();
                jQuery.noConflict();
                $("#event-id").val(null);
                $('#post-form')[0].reset();
                $('#myModal').modal('show');
            });

            // Function to handle the delete button click
            $(document).on("click", ".delete-button", function () {
                var id = $(this).data("id");
                if (confirm("Are you sure you want to delete this post?")) {
                    $.ajax({
                        url: "/api/event/" + id,
                        type: "DELETE",
                        success: function (response) {
                            alert("Delete Successfully!");
                            loadData();
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error deleting : " + errorThrown);
                        }
                    });
                }
            });

        });
    </script>
