@{
	ViewData["Title"] = "Blog";
}

<div class="panel-heading">
	<h3 class="panel-title"><a href="javascript:void(0);" class="toggle-sidebar"><span class="fa fa-angle-double-left" data-toggle="offcanvas" title="Maximize Panel"></span></a>@ViewData["Title"]</h3>
</div>
<div class="panel-body">
	<div class="content-row">
            <h2 class="content-row-title">Blog Management</h2>
            <div class="page-breadcrumb bg-white">
                <div class="row align-items-center">
                    <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12">
                        <button type="button" class="btn btn-primary" id="add-button">
                            Add
                        </button>
                    </div>
                </div>
            </div>
            <table class="table" id="tableblog">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Image</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="bodyblog">
                </tbody>
            </table>
            <div class="row mt-4 content-center">
                <div class="col-md-6">
                    <ul class="pagination" id="page_container">
                    </ul>
                </div>
            </div>
            <div class="modal" id="myModal">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div class="modal-header">
                            <h4 class="modal-title"> Blog</h4>
                            <button type="button" class="btn-close" data-dismiss="modal"></button>
                        </div>

                        <!-- Modal body -->
                        <div class="modal-body">
                            <div class="form-group">
                                <form id="post-form" enctype="multipart/form-data">
                                    <input type="hidden" id="post-id" name="id">
                                    <div class="form-group">
                                        <label for="title">Title</label>
                                        <input type="text" class="form-control" id="title" name="title" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="description">Description</label>
                                        <textarea class="form-control" id="description" name="description" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="content">Content</label>
                                        <textarea class="form-control" id="content" name="content" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="image">Image</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="image" name="image">
                                        </div>
                                        <img id="image-preview" src="" height="100" style="display: none;">
                                    </div>
                                    <button type="submit" id="submit-button" class="btn btn-primary">Save</button>
                                </form>

                            </div>
                        </div>
                    </div>
            </div>
	</div>
</div>
<!-- jQuery library -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

<!-- Popper JS -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />


    <script src="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"></script>
<script>
    $(document).ready(function () {
        // Function to load data from the API and display it in the table
        function loadData() {
            $.ajax({
                url: "/api/blog",
                type: "GET",
                success: function (response) {
                    var data = response.data;
                    var tableBody = $("#bodyblog");
                    tableBody.empty();
                    for (var i = 0; i < data.length; i++) {
                        var row = "<tr>" +
                            "<td>" + data[i].id + "</td>" +
                            "<td>" + data[i].title + "</td>" +
                            "<td>" + data[i].description + "</td>" +
                            "<td><img src='" + data[i].image.url + "' height='100'></td>" +
                                "<td><button class='edit-button' data-data='" + JSON.stringify(data[i]) + "'>Edit</button></td>" +
                            "<td><button class='delete-button' data-id='" + data[i].id + "' > Delete </button></td>"+
                            "</tr>";
                        tableBody.append(row);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("Error loading data from the API: " + errorThrown);
                }
            });
        }
        loadData();
        $("#post-form").submit(function (event) {
            event.preventDefault();
            var formData = new FormData();
            formData.append("Title", $("#title").val());
            formData.append("Description",$("#description").val());
            formData.append("Content", $("#content").val());
            formData.append("file", $("#image")[0].files[0]);
            var id=$("#post-id").val();
            if (id == null || id == "") 
            {
                $.ajax({
                    url: "/api/blog",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        alert("Successfully!");
                        loadData();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("Error creating : " + errorThrown);
                    }
                });
            }
            else 
            {
                 $.ajax({
                        url: "/api/blog/"+id,
                        type: "PUT",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            alert("Successfully!");
                            loadData();
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error updating: " + errorThrown);
                        }
                    });   
            }
        });

        // Function to handle the edit button click
         $(document).on("click", ".edit-button",function () {
                event.preventDefault();
                jQuery.noConflict();
                var data = $(this).data("data");
                $("#post-id").val(data.id);
                $("#title").val(data.title);
                $("#description").val(data.description);
                $("#content").val(data.content);
                $('#image-preview').attr('src',data.image.url);
                $('#myModal').modal('show');
         });
         $(document).on("click", "#add-button", function () {
                event.preventDefault();
                jQuery.noConflict();
                $("#post-id").val(null);
                $('#post-form')[0].reset();
                $('#myModal').modal('show');
            });

        // Function to handle the delete button click
        $(document).on("click", ".delete-button", function () {
                var id = $(this).data("id");
                if (confirm("Are you sure you want to delete this post?")) {
                    $.ajax({
                        url: "/api/blog/" + id,
                        type: "DELETE",
                        success: function (response) {
                            alert("Delete Successfully!");
                            loadData();
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error deleting : " + errorThrown);
                        }
                    });
                }
         });

    });
</script>